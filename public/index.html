<!DOCTYPE html> 
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>AI Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Google Fonts Link For Icons -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
  
    <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
     <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <style>
 
    .chat-input .input-container {
      display: flex;
      width: 100%;
      align-items: center;
      text-align: center;
    }

    * {
      margin: 0;
      padding: 0;
    }

    body.show-chatbot .chatbot-toggler img {
      display: none;
    }

    body.show-chatbot .chatbot-toggler span.material-symbols-outlined.close {
      display: block;
    }

    .chatbot-toggler span.material-symbols-outlined.close {
      display: none;
    }

    .chatbot-toggler {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      outline: none;
      font-size: 14px;
      font-family: sans-serif;
      border: none;
      height: 70px;
      width: 70px;
      display: flex;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      border-radius: 20%;
      background: #a4c3ee;
      transition: all 0.2s ease;
      z-index: 1000;
    }

    body.show-chatbot .chatbot-toggler {
      transform: rotate(90deg);
    }

    .chatbot-toggler span {
      color: #fff;
      position: absolute;
    }

    .chatbot-toggler span:last-child,
    body.show-chatbot .chatbot-toggler span:first-child {
      opacity: 0;
    }

    body.show-chatbot .chatbot-toggler span:last-child {
      opacity: 1;
    }

    .chatbot {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      font-size: 14px;
      font-family: sans-serif;
      opacity: 0;
      width: 480px;
      height: 600px;
      pointer-events: none;
      transform: scale(0.5);
      transform-origin: bottom right;
      transition: all 0.1s ease;
      display: flex;
      flex-direction: column;
      position: fixed;
      right: 1rem;
      bottom: 6rem;
      z-index: 999;
    }

    body.show-chatbot .chatbot {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
    }

    .chatbot header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f8f9fa;
      padding: 10px 20px;
      border-bottom: 1px solid #e9ecef;
    }

    .chatbot header img {
      width: 35px;
      height: 35px;
      border-radius: 5px;
    }

    .chatbot header p {
      flex: 1;
      margin: 2px 0px 0px 10px;
      font-size: 1rem;
      color: #333;
      font-weight: 500;
    }

    .chatbot header .close-btn {
      cursor: pointer;
      font-size: 1.5rem;
      color: #333;
    }

    .chatbot header h2 {
      margin-bottom: 10px;
      font-size: 10px;
      color: #333;
    }

    .chatbox {
      flex: 1;
      overflow-y: auto;
      padding: 10px 20px;
    }

    .chatbox .chat-messages {
      list-style: none;
      max-height: 400px;
    }

    .chatbox .chat {
      display: flex;
      list-style: none;
    }

    .chatbox .outgoing {
      margin: 20px 0;
      justify-content: flex-end;
      font-size: 14px;
      font-family: sans-serif;
      display: flex;
      align-items: flex-end;
    }

    .chatbox .outgoing span {
      width: 32px;
      height: 32px;
      color: #b0b0b0;
      cursor: default;
      text-align: center;
      line-height: 32px;
      align-self: flex-end;
      background: #e0e0e0;
      border-radius: 4px;
      margin: 0 0 7px 10px;
    }

    .chatbox .incoming {
      margin: 20px 0;
      display: flex;
      font-size: 14px;
      font-family: sans-serif;
      align-items: flex-end;
    }

    .chatbox .chat p {
      white-space: word-wrap;
      padding: 8px 8px;
      border-radius: 10px 10px 0 10px;
      max-width: 80%;
      color: #fff;
      font-size: 14px;
      font-family: sans-serif;
      background: #186EE9;
    }

    .chatbox .incoming p {
      border-radius: 10px 10px 10px 0;
      color: #000;
      background: #f2f2f2;
    }

    .chat-input {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      border-top: 1px solid #e9ecef;
    }

    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #e9ecef;
      border-radius: 5px;
      margin-right: 10px;
      word-wrap: break-word;
    }

    .chat-input .send-btn {
      cursor: pointer;
      font-size: 1.5rem;
      color: #333;
    }

   

    .chat-input {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      border-top: 1px solid #e9ecef;
    }

    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #e9ecef;
      border-radius: 5px;
      margin-right: 10px;
    }

    .chat-input .send-btn {
      cursor: pointer;
      font-size: 1.5rem;
      color: #333;
    }

    .voice-btn{
      cursor: pointer;
      font-size: 1.5rem;
      color: #186EE9;
      border-style: none;
      background-color: white;
    }

    .voice-btn:hover{
      color: red;
    }
    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 4px 4px;
    }

    .typing-indicator span {
      display: inline-block;
      width: 6px;
      height: 6px;
      margin: 0 2px;
      background-color: #c3c3c3;
      border-radius: 50%;
      animation: typing 1.5s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.3s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.6s;
    }

    @keyframes typing {

      0%,
      80%,
      100% {
        transform: scale(0);
      }

      40% {
        transform: scale(1);
      }
    }


    @media (max-width: 768px) {
      .chatbot-toggler {
        width: 49px;
        height: 49px;
      }

      .chatbot {
        width: 100vw;
        min-height: 100vh;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 0;
        z-index: 1999;
        overflow: hidden;
      }
      .input-container {
      display: flex;
      width: 100%;
      align-items: center;
      text-align: center;
      margin-bottom: 80px;
    }

    }
    .external-link{
        margin-right: 20px;
        font-size: 20px;
    }
  </style>
</head>

<body>
  <button class="chatbot-toggler">
    <img src="https://firebasestorage.googleapis.com/v0/b/foodapp-lqii.appspot.com/o/socialintents-logo-primary-removebg-preview.png?alt=media&token=2c72c670-0678-411c-9562-770dc2ed9c42" width="40px" />
    <span class="material-symbols-outlined close" style="display: none">close</span>
  </button>

  <div class="chatbot">
    <header>
      <img src="https://firebasestorage.googleapis.com/v0/b/foodapp-lqii.appspot.com/o/socialintents-logo-primary-removebg-preview.png?alt=media&token=2c72c670-0678-411c-9562-770dc2ed9c42" width="40px" />
     
      <p style="font: bold; font-weight: 700"> AI Assitant</p>
      
        <!--<span class="material-symbols-outlined">near_me</span>-->
       <!-- <span class="external-link"> <i class="fas fa-external-link"></i></span>  -->
      </a>
      <span class="material-symbols-outlined close-btn">close</span>
    </header>
    <div class="chatbox">
      <ul class="chat-messages">
        <li class="chat incoming">
          <img src="https://firebasestorage.googleapis.com/v0/b/foodapp-lqii.appspot.com/o/socialintents-logo-primary-removebg-preview.png?alt=media&token=2c72c670-0678-411c-9562-770dc2ed9c42" width="32px" height="32px"
            style="border-radius: 4px; margin-right: 10px" />
        
          <p style="white-space: normal !important;">
            Hi there ðŸ‘‹
            <br />
            How can I help you today? Ask any questions about </span>
           anything
          </p>
        </li>
      </ul>
    </div>
 
    <div class="chat-input">
      <div class="input-container">
        <input type="text" placeholder="Ask any questions..." spellcheck="false" name="ask_prompt" required />
        <button class="voice-btn"><span class="material-symbols-rounded">mic</span></button>
        <span class="material-symbols-rounded send-btn">send</span>
      
      </div>
    </div>
    

      
    </div>
  </div>

  <script>
    const chatbotToggler = document.querySelector(".chatbot-toggler");
    const closeBtn = document.querySelector(".close-btn");
    const chatbox = document.querySelector(".chatbox .chat-messages");
    const chatWindow = document.querySelector(".chatbox");
    const chatInput = document.querySelector(".chat-input input");
    const sendChatBtn = document.querySelector(".send-btn");
    const voiceBtn = document.querySelector('.voice-btn');

    voiceBtn.addEventListener('click', startVoiceRecognition);
    function startVoiceRecognition() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
    
            recognition.start();
    
            recognition.onresult = function (event) {
              const transcript = event.results[0][0].transcript;
              chatInput.value = transcript;
              sendMessage();
            };
    
            recognition.onerror = function (event) {
              console.error('Speech recognition error detected: ' + event.error);
            };
    
            recognition.onend = function () {
              console.log('Speech recognition service disconnected');
            };
          }
    // const regenerateBtn = document.querySelector(".regenerate-btn");
    let userMessage = null;
    let lastUserMessage = null;
    let generatingResponse = false;
    let abortController = null;
    let typingIndicator = null;

    const createChatLi = (message, className) => {
      const chatLi = document.createElement("li");
      chatLi.classList.add("chat", `${className}`);
      let chatContent;
      if (className === "outgoing") {
        chatContent = `<p></p><span class="material-symbols-outlined">person</span>`;
      } else {
        chatContent = `<img src="https://firebasestorage.googleapis.com/v0/b/foodapp-lqii.appspot.com/o/socialintents-logo-primary-removebg-preview.png?alt=media&token=2c72c670-0678-411c-9562-770dc2ed9c42" width="32px" height="32px" style="border-radius: 4px; margin-right: 10px;"/><p></p>`;
      }
      chatLi.innerHTML = chatContent;
      chatLi.querySelector("p").textContent = message;
      return chatLi;
    };

    const generateResponse = async (chatElement) => {
            const messageElement = chatElement.querySelector("p");

            try {
                const response = await fetch('http://localhost:3000/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: userMessage })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                messageElement.textContent = "";
                stopEllipsisAnimation();
                startTypingAnimation(messageElement, data.message);
                
            } catch (error) {
                stopEllipsisAnimation();
                messageElement.classList.add("error");
                messageElement.textContent = "Oops! Something went wrong. Please try again.";
            }
        };
    
    
    const speakResponse = (text) => {
      speechSynthesis.cancel(); // Stop any ongoing speech
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 1.1; // Adjust the rate as needed (0.1 to 10)
        speechSynthesis.speak(utterance);
    };


    const startTypingAnimation = (element, message) => {
      let currentIndex = 0;
      let currentText = "";
      let intervalId = setInterval(() => {
        if (currentIndex < message.length) {
          currentText += message[currentIndex];
          // Generate HTML dynamically here
          element.innerHTML = convertToHTML(currentText);
          currentIndex++;
        } else {
          clearInterval(intervalId);
        }
        // Ensure the chat window scrolls to the bottom
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }, 1);
    };

    // Function to convert Markdown-style headings to HTML headings
    function convertHeadings(text) {
      return text.replace(/### (.*?)\n/g, '<h6>$1</h6>');
    }

    // Function to convert Markdown-style bold text to HTML bold tags
    function convertBold(text) {
      return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    }

    // Function to convert Markdown-style lists to HTML lists
    function convertLists(text) {
      return text.replace(/- (.*?)\n/g, '<li>$1</li>');
    }

    // Function to convert the entire content to HTML
    function convertToHTML(content) {
      let html = content;

      html = convertHeadings(html);
      html = convertBold(html);
      html = convertLists(html);

      // Convert remaining new lines to paragraphs
      html = html.replace(/\n\n/g, '</p><p>');
      html = '<p style="padding-top: 0px; margin-bottom: 0px;">' + html + '</p>';

      return html;
    }

    const handleChat = () => {
      userMessage = chatInput.value.trim();
      if (!userMessage) return;

      lastUserMessage = userMessage;
      chatInput.value = "";
      chatInput.style.height = `${inputInitHeight}px`;

      chatbox.appendChild(createChatLi(userMessage, "outgoing"));
      chatWindow.scrollTop = chatWindow.scrollHeight;

    

      // Show the beta preview message
    //   document.querySelector(".beta-preview-message").style.display = "block";

      setTimeout(() => {
        const incomingChatLi = createChatLi("", "incoming");
        chatbox.appendChild(incomingChatLi);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        startEllipsisAnimation(incomingChatLi.querySelector("p"));
        generateResponse(incomingChatLi);
      }, 600);
    };

    const regenerateResponse = () => {
      if (generatingResponse) {
        stopGenerating();
      } else {
        if (!lastUserMessage) return;
        userMessage = lastUserMessage;

        

        setTimeout(() => {
          const incomingChatLi = createChatLi("", "incoming");
          chatbox.appendChild(incomingChatLi);
          chatWindow.scrollTop = chatWindow.scrollHeight;
          startEllipsisAnimation(incomingChatLi.querySelector("p"));
          generateResponse(incomingChatLi);
        }, 600);
      }
    };

    // const stopGenerating = () => {
    //   if (abortController) {
    //     abortController.abort(); // Abort the fetch request
    //     generatingResponse = false;
    //     regenerateBtn.textContent = "Regenerate Response";
    //     stopEllipsisAnimation();
    //   }
    // };

    const startEllipsisAnimation = (parentElement) => {
      typingIndicator = document.createElement("div");
      typingIndicator.classList.add("typing-indicator");
      typingIndicator.innerHTML = '<span></span><span></span><span></span>';
      if (parentElement) parentElement.appendChild(typingIndicator);
    };

    const stopEllipsisAnimation = () => {
      if (typingIndicator) {
        typingIndicator.remove();
        typingIndicator = null;
      }
    };

    // Example usage: Add this logic where you start the animation
    document.addEventListener("DOMContentLoaded", () => {
      const ellipsisElement = document.querySelector(".ellipsis-container");
      startEllipsisAnimation(ellipsisElement);
    });


    chatInput.addEventListener("input", () => {
      chatInput.style.height = `${inputInitHeight}px`;
      chatInput.style.height = `${chatInput.scrollHeight}px`;
    });

    sendChatBtn.addEventListener("click", handleChat);
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey && window.innerWidth > 800) {
        e.preventDefault();
        handleChat();
      }
    });

    // regenerateBtn.addEventListener("click", regenerateResponse);

    chatbotToggler.addEventListener("click", () => {
      document.body.classList.toggle("show-chatbot");
      toggleIcons();
    });

    closeBtn.addEventListener("click", () => {
      document.body.classList.remove("show-chatbot");
      toggleIcons();
    });

    const toggleIcons = () => {
      const logoIcon = document.querySelector(".chatbot-toggler img");
      const closeIcon = document.querySelector(
        ".chatbot-toggler span.material-symbols-outlined.close"
      );

      if (document.body.classList.contains("show-chatbot")) {
        logoIcon.style.display = "none";
        closeIcon.style.display = "block";
      } else {
        logoIcon.style.display = "block";
        closeIcon.style.display = "none";
      }
    };

    const inputInitHeight = chatInput.scrollHeight;

    document.addEventListener("DOMContentLoaded", () => {
        toggleIcons();
        speechSynthesis.cancel(); // Stop any ongoing speech on page refresh
    });

  </script>

</body>

</html>